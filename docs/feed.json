{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "Dan Gibbs Feed",
  "language": "en-GB",
  "home_page_url": "https://dangibbs.uk",
  "feed_url": "https://dangibbs.uk/feed.json",
  "description": "Posts and articles from dangibbs.uk",
  "author": {
    "name": "Dan Gibbs",
    "url": "https://dangibbs.uk"
  },
  "items": [{
      "id": "https://dangibbs.uk/blog/using-oauth-roles-in-grafana-with-keycloak/",
      "url": "https://dangibbs.uk/blog/using-oauth-roles-in-grafana-with-keycloak/",
      "title": "Setting Grafana Roles with Keycloak over OAuth",
      "content_html": "<p>When signing in to Grafana via OAuth the dashboard will default to the &quot;Viewer&quot;\nrole if a specific role can not be matched. Roles need to be supplied to the\nOAuth UserInfo endpoint to support logging in as an Admin or Editor.</p>\n<p>See the <a href=\"https://grafana.com/docs/grafana/latest/auth/generic-oauth/\">Generic OAuth authentication</a>\ndocumentation for useful information.</p>\n<h2 id=\"goto-matching-keycloak-roles-with-grafana\" tabindex=\"-1\">Matching Keycloak Roles with Grafana</h2>\n<p>Set the <code>role_attribute_path</code> property to match <code>roles.admin</code> and <code>roles.editor</code>.\nIf OAuth contains neither role the attribute will fallback to the viewer role\n(matching the default Grafana behaviour):</p>\n<pre class=\"language-ini\" tabindex=\"0\"><code class=\"language-ini\"><span class=\"token comment\"># /etc/grafana/grafana.ini</span><br><span class=\"token header\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">auth.generic_oauth</span><span class=\"token punctuation\">]</span></span><br><span class=\"token key attr-name\">role_attribute_path</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">contains(roles[*], 'admin') &amp;&amp; 'Admin' || contains(roles[*], 'editor') &amp;&amp; 'Editor' || 'Viewer'</span></code></pre>\n<h2 id=\"goto-setup-the-keycloak-roles\" tabindex=\"-1\">Setup the Keycloak Roles</h2>\n<p>In the Keycloak admin area create 2 new roles under <mark>Configure &gt; Roles</mark>\nnamed <code>admin</code> and <code>editor</code>.</p>\n<p>Under <mark>Configure &gt; Clients</mark> select the client and go to the <mark>Mappers</mark> tab.\nCreate a new protocol mapper with the following settings:</p>\n<ul>\n<li><strong>Name</strong>: roles</li>\n<li><strong>Mapper Type</strong>: User Realm Role</li>\n<li><strong>Multivalued</strong>: on</li>\n<li><strong>Token Claim Name</strong>: roles</li>\n<li><strong>Claim JSON Type</strong>: String</li>\n<li><strong>Add to ID token</strong>: on</li>\n<li><strong>Add to access token</strong>: on</li>\n<li><strong>Add to userinfo</strong>: on</li>\n</ul>\n<p><picture><source type=\"image/avif\" sizes=\"749px\" srcset=\"https://dangibbs.uk/assets/images/scaled/keycloak-create-protocol-mapper-4f5e1cc09df75feb41e06922cac7b77e.avif 749w\"><source type=\"image/webp\" sizes=\"749px\" srcset=\"https://dangibbs.uk/assets/images/scaled/keycloak-create-protocol-mapper-4f5e1cc09df75feb41e06922cac7b77e.webp 749w\"><source type=\"image/jpeg\" sizes=\"749px\" srcset=\"https://dangibbs.uk/assets/images/scaled/keycloak-create-protocol-mapper-4f5e1cc09df75feb41e06922cac7b77e.jpeg 749w\"><img width=\"749\" height=\"553\" alt=\"Keycloak Create Grafana Role Protocol Mapper\" class=\"fallback--img\" decoding=\"async\" src=\"https://dangibbs.uk/assets/images/scaled/keycloak-create-protocol-mapper-4f5e1cc09df75feb41e06922cac7b77e.jpeg\"></picture></p>\n<p>After creating this mapper the roles data should now be added to the UserInfo\nendpoint.</p>\n<p>Finally, under <mark>Manage &gt; Users</mark> select a user, go to the <mark>Role Mappings</mark>\ntab and assign one of the newly added roles. Sign in to Grafana with the\nselected user and they should now have the relevant role.</p>\n<h2 id=\"goto-testing-the-userinfo-endpoint-in-keycloak\" tabindex=\"-1\">Testing the UserInfo Endpoint in Keycloak</h2>\n<p>The Keycloak admin area provides an interface for evaluating a users UserInfo\nendpoint data. This can be used to check that roles are being returned to\nGrafana as intended.</p>\n<p>Under <mark>Configure &gt; Clients</mark>:</p>\n<ul>\n<li>Select the client and go to the <mark>Client Scopes</mark> tab</li>\n<li>Select the nested <mark>Evaluate</mark> tab</li>\n<li>Go to the <mark>Select a user...</mark> dropdown, enter a user and click <mark>Evaluate</mark></li>\n<li>Select the <mark>Generated User Info</mark> tab</li>\n</ul>\n<p><picture><source type=\"image/avif\" sizes=\"1375px\" srcset=\"https://dangibbs.uk/assets/images/scaled/keycloak-generate-user-info-ecbdb7763a10ab661fe082ebfb721ac7.avif 1375w\"><source type=\"image/webp\" sizes=\"1375px\" srcset=\"https://dangibbs.uk/assets/images/scaled/keycloak-generate-user-info-ecbdb7763a10ab661fe082ebfb721ac7.webp 1375w\"><source type=\"image/jpeg\" sizes=\"1375px\" srcset=\"https://dangibbs.uk/assets/images/scaled/keycloak-generate-user-info-ecbdb7763a10ab661fe082ebfb721ac7.jpeg 1375w\"><img width=\"1375\" height=\"852\" alt=\"Keycloak View Generated UserInfo Endpoint\" class=\"fallback--img\" decoding=\"async\" src=\"https://dangibbs.uk/assets/images/scaled/keycloak-generate-user-info-ecbdb7763a10ab661fe082ebfb721ac7.jpeg\"></picture></p>\n<p>Setting the Grafana log level to <code>debug</code> can also be used to log information\nreturned from OAuth requests.</p>\n<pre class=\"language-ini\" tabindex=\"0\"><code class=\"language-ini\"><span class=\"token comment\"># /etc/grafana/grafana.ini</span><br><span class=\"token header\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">log.file</span><span class=\"token punctuation\">]</span></span><br><span class=\"token key attr-name\">level</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">debug</span></code></pre>\n",
      "date_published": "2022-01-21T00:00:00Z"
    },{
      "id": "https://dangibbs.uk/blog/running-systemd-docker-containers-archlinux/",
      "url": "https://dangibbs.uk/blog/running-systemd-docker-containers-archlinux/",
      "title": "How to run systemd Docker containers in Arch Linux",
      "content_html": "<p>Docker engine <a href=\"https://docs.docker.com/engine/release-notes/#20106\">20.10.6</a>\nrecently moved its cgroup v2 support out of experimental but it does not\nsupport <em>hybrid</em> hierarchies. Most modern systemd packages for Linux\ndistributions are compiled and shipped with the hybrid hierarchy which is a\nsystemd recommended default.</p>\n<p>You can view your host systemd environment with:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\">systemctl show -all <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> default-hierarchy</code></pre>\n<p>If the default hierarchy is listed as hybrid <code>default-hierarchy=hybrid</code> there\nwill likely be issues (regardless of read/write permissions) when running\nsystemd as an init system inside a Docker container.</p>\n<h2 id=\"goto-example\" tabindex=\"-1\">Example</h2>\n<p>Running the following <code>litmusimage/ubuntu</code> container fails to start.</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\">docker run -it --privileged --volume /sys/fs/cgroup:/sys/fs/cgroup:ro --tmpfs /tmp:exec litmusimage/ubuntu:20.04</code></pre>\n<p>Example init errors returned:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\">Failed to create /init.scope control group: Read-only <span class=\"token function\">file</span> system<br>Failed to allocate manager object: Read-only <span class=\"token function\">file</span> system<br><span class=\"token punctuation\">[</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">]</span> Failed to allocate manager object.<br>Exiting PID <span class=\"token number\">1</span><span class=\"token punctuation\">..</span>.</code></pre>\n<h2 id=\"goto-workaround\" tabindex=\"-1\">Workaround</h2>\n<p>Disable the hybrid hierarchy by setting the kernel parameter\n<code>systemd.unified_cgroup_hierarchy=0</code> from your boot loader or during kernel\ncompilation.</p>\n<h2 id=\"goto-grub-example\" tabindex=\"-1\">GRUB Example</h2>\n<p>Kernel parameters can be set in GRUB 2 by appending the <code>GRUB_CMDLINE_LINUX</code>\nor <code>GRUB_CMDLINE_LINUX_DEFAULT</code> options.</p>\n<pre class=\"language-ini\" tabindex=\"0\"><code class=\"language-ini\"><span class=\"token comment\"># /etc/default/grub</span><br><span class=\"token key attr-name\">GRUB_CMDLINE_LINUX_DEFAULT</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">\"\"</span><br><span class=\"token key attr-name\">GRUB_CMDLINE_LINUX</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">\"<span class=\"token inner-value\">quiet systemd.unified_cgroup_hierarchy=0</span>\"</span></code></pre>\n<p>Regenerate the GRUB configuration with:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"token function\">grub-mkconfig</span> -o /boot/grub/grub.cfg</code></pre>\n",
      "date_published": "2021-12-21T00:00:00Z"
    }
  ]
}
